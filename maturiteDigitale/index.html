<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Maturit√© Digitale - Formulaire Universel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }

        .question-group {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .question-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: #e3f2fd;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .radio-group-item {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e3f2fd;
        }

        .question-sub-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1em;
        }

        .radio-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .radio-option:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .radio-option input[type="radio"] {
            margin-right: 10px;
            transform: scale(1.1);
        }

        .radio-option input[type="radio"]:checked + .radio-label {
            font-weight: 600;
        }

        .radio-option:has(input[type="radio"]:checked) {
            background: #e8f5e8;
            border-color: #4caf50;
        }

        .text-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 10px;
            transition: border-color 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .textarea {
            min-height: 100px;
            resize: vertical;
        }

        .sector-selection {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .sector-selection h3 {
            color: #2e7d32;
            margin-bottom: 15px;
        }

        .sector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .sector-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .sector-item:hover {
            border-color: #4caf50;
        }

        .sector-item input[type="radio"] {
            margin-right: 10px;
        }

        .api-config {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .api-config h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .api-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .api-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .api-item:hover {
            border-color: #f39c12;
        }

        .api-item input[type="radio"] {
            margin-right: 10px;
        }

        .generate-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.6);
        }

        .generate-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .utility-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .utility-btn {
            background: #95a5a6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .utility-btn:hover {
            background: #7f8c8d;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .report-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin: 30px 0;
        }

        .chart-wrapper {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            height: 400px; /* Hauteur fixe pour un meilleur contr√¥le */
            display: flex;
            flex-direction: column;
        }

        .chart-wrapper h3 {
            margin-bottom: 15px;
            flex-shrink: 0; /* √âviter que le titre se r√©tr√©cisse */
        }

        .chart-wrapper canvas {
            flex: 1; /* Le canvas prend tout l'espace restant */
            max-height: 350px;
        }

        .report-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .score-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .score-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            flex: 1;
            min-width: 120px;
        }

        .score-value {
            font-size: 2em;
            font-weight: bold;
        }

        .score-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .api-help {
            font-size: 0.85em;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                grid-template-columns: 1fr;
            }

            .chart-wrapper {
                height: 350px; /* Hauteur r√©duite sur mobile */
            }

            .chart-wrapper canvas {
                max-height: 300px;
            }
            
            .sector-grid, .api-selection {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Audit Maturit√© Digitale</h1>
            <p>√âvaluation universelle de la transformation num√©rique - Tous secteurs d'activit√©</p>
        </div>

        <!-- Configuration API -->
        <div class="api-config">
            <h3>Configuration API</h3>
            
            <div class="api-selection">
                <label class="api-item">
                    <input type="radio" name="api_provider" value="anthropic" checked> Claude (Anthropic)
                </label>
                <label class="api-item">
                    <input type="radio" name="api_provider" value="openai"> GPT (OpenAI)
                </label>
                <label class="api-item">
                    <input type="radio" name="api_provider" value="gemini"> Gemini (Google)
                </label>
                <label class="api-item">
                    <input type="radio" name="api_provider" value="grok"> Grok (xAI)
                </label>
            </div>

            <div style="position: relative;">
                <input type="password" id="apiKey" class="text-input" placeholder="Cl√© API" style="margin-bottom: 10px; padding-right: 120px;">
                <button id="saveApiKeyBtn" onclick="saveApiKey()" class="utility-btn" style="position: absolute; right: 5px; top: 5px; background: #27ae60; padding: 5px 10px; font-size: 0.8em;">üíæ Sauver</button>
            </div>
            
            <div class="api-help" id="apiHelp">
                <strong>Claude (Anthropic):</strong> Cl√© format "sk-ant-..." - Recommand√© pour l'analyse business<br>
                <strong>Endpoint:</strong> https://api.anthropic.com/v1/messages<br>
                <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 8px; border-radius: 4px; margin-top: 8px; font-size: 0.85em;">
                    ‚úÖ <strong>Proxy PHP inclus :</strong> Les appels API passent maintenant par api-proxy.php<br>
                    R√©solution automatique des probl√®mes CORS. N√©cessite PHP sur le serveur.
                </div>
            </div>
            
            <div style="font-size: 0.9em; color: #856404; margin-top: 10px;">
                <p id="apiSecurityInfo">üîí Cl√© API sauvegard√©e localement dans votre navigateur - <button onclick="clearSavedApiKey()" style="background: #e74c3c; color: white; border: none; padding: 2px 8px; border-radius: 3px; font-size: 0.8em; cursor: pointer;">Effacer</button></p>
            </div>
        </div>

        <!-- S√©lection du secteur -->
        <div class="sector-selection">
            <h3>Secteur d'activit√© de l'entreprise</h3>
            <div class="sector-grid">
                <label class="sector-item">
                    <input type="radio" name="sector" value="industrie"> Industrie & Manufacturing
                </label>
                <label class="sector-item">
                    <input type="radio" name="sector" value="btp"> BTP & Construction
                </label>
                <label class="sector-item">
                    <input type="radio" name="sector" value="services"> Services & Conseil
                </label>
                <label class="sector-item">
                    <input type="radio" name="sector" value="commerce"> Commerce & Distribution
                </label>
                <label class="sector-item">
                    <input type="radio" name="sector" value="sante"> Sant√© & M√©dical
                </label>
                <label class="sector-item">
                    <input type="radio" name="sector" value="education"> √âducation & Formation
                </label>
                <label class="sector-item">
                    <input type="radio" name="sector" value="transport"> Transport & Logistique
                </label>
                <label class="sector-item">
                    <input type="radio" name="sector" value="agriculture"> Agriculture & Agroalimentaire
                </label>
                <label class="sector-item">
                    <input type="radio" name="sector" value="finance"> Finance & Banque
                </label>
                <label class="sector-item">
                    <input type="radio" name="sector" value="autre"> Autre secteur
                </label>
            </div>
            <input type="text" id="sector_custom" class="text-input" placeholder="Pr√©cisez le secteur si 'Autre'" style="display: none;">
        </div>

        <!-- Informations g√©n√©rales -->
        <div class="form-section">
            <h2 class="section-title">Informations G√©n√©rales</h2>
            
            <div class="question-group">
                <div class="question-title">Entreprise audit√©e</div>
                <input type="text" id="company_name" class="text-input" placeholder="Nom de l'entreprise">
                <input type="text" id="contact_name" class="text-input" placeholder="Nom du contact principal">
                <input type="text" id="contact_role" class="text-input" placeholder="Fonction du contact">
                <input type="text" id="audit_date" class="text-input" type="date">
                <input type="number" id="employee_count" class="text-input" placeholder="Nombre d'employ√©s">
            </div>

            <div class="question-group">
                <div class="question-title">Contexte de l'entreprise</div>
                <textarea id="company_context" class="text-input textarea" placeholder="D√©crivez bri√®vement l'activit√©, les produits/services, les sp√©cificit√©s de l'entreprise..."></textarea>
            </div>
        </div>

        <!-- Processus Commercial & Marketing -->
        <div class="form-section">
            <h2 class="section-title">Commercial & Marketing</h2>
            
            <div class="question-group">
                <div class="question-title">Gestion clients et prospects</div>
                <div class="checkbox-group">
                    <div class="radio-group-item">
                        <div class="question-sub-title">CRM ou base clients structur√©e</div>
                        <div class="radio-options">
                            <label class="radio-option">
                                <input type="radio" name="crm_structure" value="0">
                                <span class="radio-label">‚ùå Contacts g√©r√©s manuellement (Excel, carnet)</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="crm_structure" value="0.5">
                                <span class="radio-label">‚ö†Ô∏è Outil basique de gestion contacts</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="crm_structure" value="1">
                                <span class="radio-label">‚úÖ CRM complet avec historique et automation</span>
                            </label>
                        </div>
                    </div>
                    <label class="checkbox-item">
                        <input type="checkbox" name="commercial" value="prospection_digitale"> Prospection digitale (emails, r√©seaux sociaux)
                    </label>
                    <div class="radio-group-item">
                        <div class="question-sub-title">Site web professionnel et optimis√©</div>
                        <div class="radio-options">
                            <label class="radio-option">
                                <input type="radio" name="site_web_pro" value="0">
                                <span class="radio-label">‚ùå Aucun site ou site vitrine basique</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="site_web_pro" value="0.5">
                                <span class="radio-label">‚ö†Ô∏è Site existant mais √† moderniser</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="site_web_pro" value="1">
                                <span class="radio-label">‚úÖ Site professionnel optimis√© (SEO, responsive)</span>
                            </label>
                        </div>
                    </div>
                    <label class="checkbox-item">
                        <input type="checkbox" name="commercial" value="reseaux_sociaux"> Pr√©sence active sur r√©seaux sociaux
                    </label>
                    <div class="radio-group-item">
                        <div class="question-sub-title">Marketing automation/email campaigns</div>
                        <div class="radio-options">
                            <label class="radio-option">
                                <input type="radio" name="marketing_automation" value="0">
                                <span class="radio-label">Emails manuels occasionnels</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="marketing_automation" value="0.5">
                                <span class="radio-label">Newsletter simple avec outil basique</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="marketing_automation" value="1">
                                <span class="radio-label">Sc√©narios automatis√©s et segmentation avanc√©e</span>
                            </label>
                        </div>
                    </div>
                    <div class="radio-group-item">
                        <div class="question-sub-title">Analytics et mesure de performance</div>
                        <div class="radio-options">
                            <label class="radio-option">
                                <input type="radio" name="analytics" value="0">
                                <span class="radio-label">Aucun suivi des performances web</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="analytics" value="0.5">
                                <span class="radio-label">Google Analytics basique install√©</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="analytics" value="1">
                                <span class="radio-label">Analytics avanc√©s avec segmentation et tableaux de bord</span>
                            </label>
                        </div>
                    </div>
                </div>
                <textarea id="commercial_notes" class="text-input textarea" placeholder="Observations sp√©cifiques sur les processus commerciaux et marketing..."></textarea>
            </div>

            <div class="question-group">
                <div class="question-title">Processus de vente et devis</div>
                <div class="checkbox-group">
                    <div class="radio-group-item">
                        <div class="question-sub-title">Logiciel de devis/facturation d√©di√©</div>
                        <div class="radio-options">
                            <label class="radio-option">
                                <input type="radio" name="logiciel_devis" value="0">
                                <span class="radio-label">Devis/factures sur Excel ou Word</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="logiciel_devis" value="0.5">
                                <span class="radio-label">Logiciel comptable simple</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="logiciel_devis" value="1">
                                <span class="radio-label">ERP int√©gr√© avec workflow automatis√©</span>
                            </label>
                        </div>
                    </div>
                    <label class="checkbox-item">
                        <input type="checkbox" name="vente" value="configurateur"> Configurateur produits/services en ligne
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="vente" value="signature_electronique"> Signature √©lectronique des contrats
                    </label>
                    <div class="radio-group-item">
                        <div class="question-sub-title">Suivi pipeline commercial structur√©</div>
                        <div class="radio-options">
                            <label class="radio-option">
                                <input type="radio" name="suivi_pipeline" value="0">
                                <span class="radio-label">Suivi informel ou mental</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="suivi_pipeline" value="0.5">
                                <span class="radio-label">Tableau Excel ou outil simple</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="suivi_pipeline" value="1">
                                <span class="radio-label">CRM avec scoring et automatisation</span>
                            </label>
                        </div>
                    </div>
                    <label class="checkbox-item">
                        <input type="checkbox" name="vente" value="reporting_commercial"> Reporting commercial automatis√©
                    </label>
                </div>
                <textarea id="vente_notes" class="text-input textarea" placeholder="Processus de vente, outils utilis√©s, temps de traitement..."></textarea>
            </div>
        </div>

        <!-- Production & Op√©rations -->
        <div class="form-section">
            <h2 class="section-title">Production & Op√©rations</h2>
            
            <div class="question-group">
                <div class="question-title">Planification et suivi</div>
                <div class="checkbox-group">
                    <div class="radio-group-item">
                        <div class="question-sub-title">Planning de production digital</div>
                        <div class="radio-options">
                            <label class="radio-option">
                                <input type="radio" name="planning_digital" value="0">
                                <span class="radio-label">Planning papier ou mental</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="planning_digital" value="0.5">
                                <span class="radio-label">Excel partag√© ou outil basique</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="planning_digital" value="1">
                                <span class="radio-label">Logiciel MRP sp√©cialis√© avec optimisation</span>
                            </label>
                        </div>
                    </div>
                    <label class="checkbox-item">
                        <input type="checkbox" name="production" value="suivi_temps_reel"> Suivi de production en temps r√©el
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="production" value="gestion_priorites"> Gestion automatis√©e des priorit√©s
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="production" value="kpi_dashboards"> Tableaux de bord KPI en temps r√©el
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="production" value="maintenance_predictive"> Maintenance pr√©dictive/pr√©ventive
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="production" value="iot_capteurs"> IoT et capteurs connect√©s
                    </label>
                </div>
                <textarea id="production_notes" class="text-input textarea" placeholder="M√©thodes actuelles de planification et suivi op√©rationnel..."></textarea>
            </div>

            <div class="question-group">
                <div class="question-title">Gestion des ressources</div>
                <div class="checkbox-group">
                    <div class="radio-group-item">
                        <div class="question-sub-title">Gestion informatis√©e des stocks</div>
                        <div class="radio-options">
                            <label class="radio-option">
                                <input type="radio" name="gestion_stocks" value="0">
                                <span class="radio-label">Inventaire manuel ou carnet</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="gestion_stocks" value="0.5">
                                <span class="radio-label">Tableur avec suivi basic</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="gestion_stocks" value="1">
                                <span class="radio-label">Syst√®me temps r√©el avec alertes automatiques</span>
                            </label>
                        </div>
                    </div>
                    <label class="checkbox-item">
                        <input type="checkbox" name="ressources" value="codes_barres"> Codes-barres ou puces RFID
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="ressources" value="approvisionnement_auto"> Approvisionnement automatis√©
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="ressources" value="tracabilite"> Tra√ßabilit√© compl√®te des produits
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="ressources" value="integration_fournisseurs"> Int√©gration EDI fournisseurs
                    </label>
                </div>
            </div>
        </div>

        <!-- Service Client & Support -->
        <div class="form-section">
            <h2 class="section-title">Service Client & Support</h2>
            
            <div class="question-group">
                <div class="question-title">Gestion de la relation client</div>
                <div class="checkbox-group">
                    <div class="radio-group-item">
                        <div class="question-sub-title">Syst√®me de helpdesk/ticketing</div>
                        <div class="radio-options">
                            <label class="radio-option">
                                <input type="radio" name="helpdesk" value="0">
                                <span class="radio-label">Support par email simple</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="helpdesk" value="0.5">
                                <span class="radio-label">Outil basique de tickets</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="helpdesk" value="1">
                                <span class="radio-label">Plateforme compl√®te avec SLA et escalade</span>
                            </label>
                        </div>
                    </div>
                    <div class="radio-group-item">
                        <div class="question-sub-title">Portail client en ligne</div>
                        <div class="radio-options">
                            <label class="radio-option">
                                <input type="radio" name="portail_client" value="0">
                                <span class="radio-label">Aucun portail client</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="portail_client" value="0.5">
                                <span class="radio-label">Page web statique avec infos basiques</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="portail_client" value="1">
                                <span class="radio-label">Espace interactif avec historique et documents</span>
                            </label>
                        </div>
                    </div>
                    <label class="checkbox-item">
                        <input type="checkbox" name="service_client" value="chat_support"> Chat en ligne ou chatbot
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="service_client" value="knowledge_base"> Base de connaissances/FAQ
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="service_client" value="satisfaction_mesure"> Mesure satisfaction client automatis√©e
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="service_client" value="multi_canal"> Support multi-canal int√©gr√©
                    </label>
                </div>
                <textarea id="service_notes" class="text-input textarea" placeholder="Organisation du support client, outils et processus..."></textarea>
            </div>
        </div>

        <!-- Ressources Humaines -->
        <div class="form-section">
            <h2 class="section-title">Ressources Humaines</h2>
            
            <div class="question-group">
                <div class="question-title">Gestion RH et collaboration</div>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" name="rh" value="sirh"> SIRH (Syst√®me d'Information RH)
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="rh" value="planning_equipes"> Planning √©quipes digitalis√©
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="rh" value="formation_elearning"> Formation e-learning/LMS
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="rh" value="evaluation_performance"> √âvaluation performance digitalis√©e
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="rh" value="collaboration_tools"> Outils de collaboration (Teams, Slack...)
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="rh" value="teletravail"> Infrastructures t√©l√©travail
                    </label>
                </div>
                <textarea id="rh_notes" class="text-input textarea" placeholder="Organisation RH, niveau de digitalisation, besoins identifi√©s..."></textarea>
            </div>
        </div>

        <!-- Finance & Administration -->
        <div class="form-section">
            <h2 class="section-title">Finance & Administration</h2>
            
            <div class="question-group">
                <div class="question-title">Gestion financi√®re et administrative</div>
                <div class="checkbox-group">
                    <div class="radio-group-item">
                        <div class="question-sub-title">ERP int√©gr√© complet</div>
                        <div class="radio-options">
                            <label class="radio-option">
                                <input type="radio" name="erp_integre" value="0">
                                <span class="radio-label">Logiciel comptable simple</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="erp_integre" value="0.5">
                                <span class="radio-label">Logiciels m√©tier s√©par√©s</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="erp_integre" value="1">
                                <span class="radio-label">ERP avec modules interconnect√©s</span>
                            </label>
                        </div>
                    </div>
                    <label class="checkbox-item">
                        <input type="checkbox" name="finance" value="facturation_electronique"> Facturation √©lectronique
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="finance" value="tresorerie_temps_reel"> Suivi tr√©sorerie temps r√©el
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="finance" value="dematerialisation"> D√©mat√©rialisation administrative
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="finance" value="reporting_financier"> Reporting financier automatis√©
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="finance" value="conformite_auto"> Conformit√© r√©glementaire automatis√©e
                    </label>
                </div>
                <textarea id="finance_notes" class="text-input textarea" placeholder="Logiciels financiers, processus administratifs, niveau d'automatisation..."></textarea>
            </div>
        </div>

        <!-- Infrastructure & S√©curit√© -->
        <div class="form-section">
            <h2 class="section-title">Infrastructure & S√©curit√©</h2>
            
            <div class="question-group">
                <div class="question-title">Infrastructure technique</div>
                <div class="checkbox-group">
                    <div class="radio-group-item">
                        <div class="question-sub-title">Adoption du cloud</div>
                        <div class="radio-options">
                            <label class="radio-option">
                                <input type="radio" name="cloud_adoption" value="0">
                                <span class="radio-label">Serveurs sur site uniquement</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="cloud_adoption" value="0.5">
                                <span class="radio-label">Quelques services cloud (emails, stockage)</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="cloud_adoption" value="1">
                                <span class="radio-label">Strat√©gie hybride compl√®te avec gouvernance</span>
                            </label>
                        </div>
                    </div>
                    <div class="radio-group-item">
                        <div class="question-sub-title">Parc informatique moderne</div>
                        <div class="radio-options">
                            <label class="radio-option">
                                <input type="radio" name="parc_moderne" value="0">
                                <span class="radio-label">√âquipements obsol√®tes ou h√©t√©rog√®nes</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="parc_moderne" value="0.5">
                                <span class="radio-label">Mat√©riel r√©cent mais non standardis√©</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="parc_moderne" value="1">
                                <span class="radio-label">Infrastructure moderne optimis√©e et standardis√©e</span>
                            </label>
                        </div>
                    </div>
                    <label class="checkbox-item">
                        <input type="checkbox" name="infrastructure" value="reseau_performant"> Infrastructure r√©seau performante
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="infrastructure" value="mobilite"> Solutions de mobilit√©
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="infrastructure" value="integration_api"> Int√©grations API
                    </label>
                </div>
            </div>

            <div class="question-group">
                <div class="question-title">S√©curit√© et gouvernance</div>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" name="securite" value="cybersecurite"> Strat√©gie cybers√©curit√© avanc√©e
                    </label>
                    <div class="radio-group-item">
                        <div class="question-sub-title">Sauvegarde automatis√©e</div>
                        <div class="radio-options">
                            <label class="radio-option">
                                <input type="radio" name="sauvegarde_auto" value="0">
                                <span class="radio-label">Sauvegarde manuelle occasionnelle</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="sauvegarde_auto" value="0.5">
                                <span class="radio-label">Sauvegarde automatique basique</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="sauvegarde_auto" value="1">
                                <span class="radio-label">Syst√®me complet avec tests de restauration</span>
                            </label>
                        </div>
                    </div>
                    <label class="checkbox-item">
                        <input type="checkbox" name="securite" value="rgpd_compliance"> Conformit√© RGPD
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="securite" value="plan_continuite"> Plan de continuit√© d'activit√©
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="securite" value="formation_securite"> Formation s√©curit√© des utilisateurs
                    </label>
                </div>
                <textarea id="infrastructure_notes" class="text-input textarea" placeholder="√âtat de l'infrastructure, politique de s√©curit√©, support IT..."></textarea>
            </div>
        </div>

        <!-- Innovation & Data -->
        <div class="form-section">
            <h2 class="section-title">Innovation & Data</h2>
            
            <div class="question-group">
                <div class="question-title">Exploitation des donn√©es</div>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" name="data" value="data_strategy"> Strat√©gie data d√©finie
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="data" value="business_intelligence"> Business Intelligence/BI
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="data" value="data_analytics"> Analytics avanc√©s
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="data" value="ia_machine_learning"> IA/Machine Learning
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="data" value="data_governance"> Gouvernance des donn√©es
                    </label>
                </div>
            </div>

            <div class="question-group">
                <div class="question-title">Innovation et transformation</div>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" name="innovation" value="veille_techno"> Veille technologique organis√©e
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="innovation" value="r_et_d_digitale"> R&D digitale
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="innovation" value="partenariats_tech"> Partenariats technologiques
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="innovation" value="roadmap_digitale"> Roadmap transformation digitale
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="innovation" value="culture_innovation"> Culture d'innovation
                    </label>
                </div>
                <textarea id="innovation_notes" class="text-input textarea" placeholder="Initiatives d'innovation, projets technologiques, vision future..."></textarea>
            </div>
        </div>

        <!-- Synth√®se -->
        <div class="form-section">
            <h2 class="section-title">Synth√®se & Priorit√©s</h2>
            
            <div class="question-group">
                <div class="question-title">Points de douleur identifi√©s</div>
                <textarea id="pain_points" class="text-input textarea" placeholder="Quels sont les principaux points de douleur exprim√©s par l'entreprise ?"></textarea>
            </div>

            <div class="question-group">
                <div class="question-title">Ambitions et contraintes</div>
                <textarea id="ambitions" class="text-input textarea" placeholder="Projets de croissance, contraintes budg√©taires, app√©tence au changement..."></textarea>
            </div>

            <div class="question-group">
                <div class="question-title">Budget approximatif pour la digitalisation</div>
                <select id="budget_range" class="text-input">
                    <option value="">-- S√©lectionner une fourchette --</option>
                    <option value="0-10k">0 - 10 000 ‚Ç¨</option>
                    <option value="10k-25k">10 000 - 25 000 ‚Ç¨</option>
                    <option value="25k-50k">25 000 - 50 000 ‚Ç¨</option>
                    <option value="50k-100k">50 000 - 100 000 ‚Ç¨</option>
                    <option value="100k-250k">100 000 - 250 000 ‚Ç¨</option>
                    <option value="250k+">Plus de 250 000 ‚Ç¨</option>
                </select>
            </div>

            <div class="question-group">
                <div class="question-title">Niveau d'urgence de la transformation</div>
                <select id="urgency" class="text-input">
                    <option value="">-- S√©lectionner --</option>
                    <option value="critique">Critique - Besoin imm√©diat</option>
                    <option value="urgent">Urgent - Dans les 6 mois</option>
                    <option value="important">Important - Dans l'ann√©e</option>
                    <option value="planifie">Planifi√© - 1 √† 2 ans</option>
                    <option value="reflexion">En r√©flexion - Pas de timeline</option>
                </select>
            </div>
        </div>

        <div class="utility-buttons">
            <button class="utility-btn" onclick="loadDemoData()" style="background: #e74c3c; color: white;">üéØ D√©mo</button>
            <button class="utility-btn" onclick="resetForm()">R√©initialiser</button>
            <button class="utility-btn" onclick="saveProgress()">Sauvegarder</button>
            <button class="utility-btn" onclick="loadProgress()">Charger</button>
        </div>

        <button id="generateReport" class="generate-btn">
            G√©n√©rer le Rapport de Maturit√© Digitale
        </button>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Analyse en cours et g√©n√©ration du rapport personnalis√©...</p>
        </div>

        <!-- Section Rapport -->
        <div id="reportSection" class="report-section">
            <h2 class="section-title">Rapport de Maturit√© Digitale</h2>
            
            <div class="score-indicator" id="globalScores">
                <!-- Scores globaux g√©n√©r√©s dynamiquement -->
            </div>

            <div class="chart-container">
                <div class="chart-wrapper">
                    <h3>Radar de Maturit√© par Domaine</h3>
                    <canvas id="radarChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <h3>R√©partition des Scores</h3>
                    <canvas id="barChart"></canvas>
                </div>
            </div>

            <div class="report-content" id="reportContent">
                <!-- Contenu du rapport g√©n√©r√© par l'IA -->
            </div>

            <div class="utility-buttons">
                <button class="utility-btn" onclick="exportToPDF()">Exporter PDF</button>
                <button class="utility-btn" onclick="shareReport()">Partager</button>
                <button class="utility-btn" onclick="showUsageStats()">üìä Statistiques</button>
                <button class="utility-btn" onclick="newAudit()">Nouvel Audit</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration et variables globales
        let radarChart = null;
        let barChart = null;

        function loadDemoData() {
            if (!confirm('Cette action va remplir le formulaire avec des donn√©es de d√©monstration.\n\nVoulez-vous continuer ?')) {
                return;
            }

            // Informations g√©n√©rales
            document.getElementById('company_name').value = 'TechSolutions SARL';
            document.getElementById('contact_name').value = 'Marie Dupont';
            document.getElementById('contact_role').value = 'Directrice G√©n√©rale';
            document.getElementById('audit_date').value = new Date().toISOString().split('T')[0];
            document.getElementById('employee_count').value = '45';
            document.getElementById('company_context').value = 'TechSolutions est une entreprise de services informatiques sp√©cialis√©e dans le d√©veloppement d\'applications web et mobiles. Cr√©√©e il y a 8 ans, elle compte 45 employ√©s et r√©alise un chiffre d\'affaires de 4,2M‚Ç¨. L\'entreprise op√®re principalement en France avec quelques clients internationaux.';

            // S√©lection secteur
            document.querySelector('input[name="sector"][value="services"]').checked = true;

            // Configuration API (optionnelle pour la d√©mo)
            document.querySelector('input[name="api_provider"][value="anthropic"]').checked = true;

            // Commercial & Marketing - nouveaux champs radio
            document.querySelector('input[name="crm_structure"][value="0.5"]').checked = true;
            document.querySelector('input[name="site_web_pro"][value="1"]').checked = true;
            document.querySelector('input[name="marketing_automation"][value="0.5"]').checked = true;
            document.querySelector('input[name="analytics"][value="0.5"]').checked = true;
            // Champs checkboxes restants
            document.querySelector('input[name="commercial"][value="prospection_digitale"]').checked = true;
            document.querySelector('input[name="commercial"][value="reseaux_sociaux"]').checked = true;
            document.getElementById('commercial_notes').value = 'L\'entreprise utilise un CRM basique et a un site web professionnel. Cependant, les processus de marketing automation et d\'analytics sont encore limit√©s.';

            // Vente - nouveaux champs radio
            document.querySelector('input[name="logiciel_devis"][value="1"]').checked = true;
            document.querySelector('input[name="suivi_pipeline"][value="0.5"]').checked = true;
            // Champs checkboxes restants
            document.querySelector('input[name="vente"][value="signature_electronique"]').checked = true;
            document.querySelector('input[name="vente"][value="configurateur"]').checked = true;
            document.querySelector('input[name="vente"][value="reporting_commercial"]').checked = true;
            document.getElementById('vente_notes').value = 'Processus de vente structur√© avec devis automatis√©s et signature √©lectronique. Le suivi du pipeline commercial pourrait √™tre am√©lior√©.';

            // Production & Op√©rations - nouveaux champs radio
            document.querySelector('input[name="planning_digital"][value="1"]').checked = true;
            document.querySelector('input[name="gestion_stocks"][value="0.5"]').checked = true;
            // Champs checkboxes restants
            document.querySelector('input[name="production"][value="suivi_temps_reel"]').checked = true;
            document.querySelector('input[name="production"][value="gestion_priorites"]').checked = true;
            document.querySelector('input[name="production"][value="kpi_dashboards"]').checked = true;
            document.querySelector('input[name="ressources"][value="codes_barres"]').checked = true;
            document.querySelector('input[name="ressources"][value="approvisionnement_auto"]').checked = true;
            document.getElementById('production_notes').value = 'L\'√©quipe utilise des outils de gestion de projet modernes mais la planification op√©rationnelle pourrait √™tre optimis√©e avec des tableaux de bord plus avanc√©s.';

            // Service Client - nouveaux champs radio
            document.querySelector('input[name="helpdesk"][value="1"]').checked = true;
            document.querySelector('input[name="portail_client"][value="0.5"]').checked = true;
            // Champs checkboxes restants
            document.querySelector('input[name="service_client"][value="chat_support"]').checked = true;
            document.querySelector('input[name="service_client"][value="knowledge_base"]').checked = true;
            document.querySelector('input[name="service_client"][value="satisfaction_mesure"]').checked = true;
            document.querySelector('input[name="service_client"][value="multi_canal"]').checked = true;
            document.getElementById('service_notes').value = 'Support client organis√© avec helpdesk et portail client. L\'exp√©rience pourrait √™tre enrichie avec un chatbot et une base de connaissances plus compl√®te.';

            // RH
            document.querySelector('input[name="rh"][value="sirh"]').checked = true;
            document.querySelector('input[name="rh"][value="planning_equipes"]').checked = true;
            document.querySelector('input[name="rh"][value="formation_elearning"]').checked = true;
            document.querySelector('input[name="rh"][value="collaboration_tools"]').checked = true;
            document.getElementById('rh_notes').value = 'SIRH en place avec planning digital et outils collaboratifs. La formation e-learning est utilis√©e mais pourrait √™tre √©tendue.';

            // Finance & Admin - nouveaux champs radio
            document.querySelector('input[name="erp_integre"][value="0.5"]').checked = true;
            // Champs checkboxes restants
            document.querySelector('input[name="finance"][value="facturation_electronique"]').checked = true;
            document.querySelector('input[name="finance"][value="reporting_financier"]').checked = true;
            document.querySelector('input[name="finance"][value="dematerialisation"]').checked = true;
            document.querySelector('input[name="finance"][value="tresorerie_temps_reel"]').checked = true;
            document.getElementById('finance_notes').value = 'ERP int√©gr√© avec facturation √©lectronique et d√©mat√©rialisation administrative. Le reporting financier est automatis√©.';

            // Infrastructure - nouveaux champs radio
            document.querySelector('input[name="cloud_adoption"][value="1"]').checked = true;
            document.querySelector('input[name="parc_moderne"][value="0.5"]').checked = true;
            document.querySelector('input[name="sauvegarde_auto"][value="1"]').checked = true;
            // Champs checkboxes restants
            document.querySelector('input[name="infrastructure"][value="reseau_performant"]').checked = true;
            document.querySelector('input[name="infrastructure"][value="integration_api"]').checked = true;
            document.querySelector('input[name="infrastructure"][value="mobilite"]').checked = true;
            document.querySelector('input[name="securite"][value="cybersecurite"]').checked = true;
            document.querySelector('input[name="securite"][value="rgpd_compliance"]').checked = true;
            document.querySelector('input[name="securite"][value="plan_continuite"]').checked = true;
            document.getElementById('infrastructure_notes').value = 'Infrastructure cloud moderne avec s√©curit√© avanc√©e. Bonne conformit√© RGPD et sauvegardes automatiques.';

            // Innovation & Data
            document.querySelector('input[name="data"][value="business_intelligence"]').checked = true;
            document.querySelector('input[name="data"][value="data_analytics"]').checked = true;
            document.querySelector('input[name="data"][value="data_governance"]').checked = true;
            document.querySelector('input[name="innovation"][value="veille_techno"]').checked = true;
            document.querySelector('input[name="innovation"][value="roadmap_digitale"]').checked = true;
            document.getElementById('innovation_notes').value = 'Business Intelligence en place avec analytics avanc√©s. Veille technologique organis√©e et roadmap digitale d√©finie.';

            // Synth√®se
            document.getElementById('pain_points').value = 'Difficult√©s de recrutement de profils techniques, concurrence accrue sur le march√©, besoin d\'acc√©l√©rer la transformation digitale pour rester comp√©titif.';
            document.getElementById('ambitions').value = 'Croissance de 30% en 2 ans, diversification vers de nouveaux secteurs, am√©lioration de la productivit√© de 25%, d√©veloppement de l\'innovation produit.';
            document.getElementById('budget_range').value = '50k-100k';
            document.getElementById('urgency').value = 'important';

            // Sauvegarde automatique
            saveProgress();

            alert('‚úÖ Donn√©es de d√©monstration charg√©es !\n\nVous pouvez maintenant g√©n√©rer le rapport pour voir le r√©sultat.');
        }

        // Configuration API dynamique
        const apiConfigs = {
            anthropic: {
                name: 'Claude (Anthropic)',
                placeholder: 'Cl√© format sk-ant-...',
                endpoint: 'https://api.anthropic.com/v1/messages',
                help: 'Claude (Anthropic): Cl√© format "sk-ant-..." - Recommand√© pour l\'analyse business<br>Endpoint: https://api.anthropic.com/v1/messages'
            },
            openai: {
                name: 'GPT (OpenAI)',
                placeholder: 'Cl√© format sk-...',
                endpoint: 'https://api.openai.com/v1/chat/completions',
                help: 'GPT (OpenAI): Cl√© format "sk-..." - Excellent pour l\'analyse g√©n√©rale<br>Endpoint: https://api.openai.com/v1/chat/completions'
            },
            gemini: {
                name: 'Gemini (Google)',
                placeholder: 'Cl√© API Google AI',
                endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent',
                help: 'Gemini (Google): Cl√© API Google AI - Bon pour l\'analyse multimodale<br>Endpoint: https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent'
            },
            grok: {
                name: 'Grok (xAI)',
                placeholder: 'Cl√© API xAI',
                endpoint: 'https://api.x.ai/v1/chat/completions',
                help: 'Grok (xAI): Cl√© API xAI - Approche directe et sans d√©tours<br>Endpoint: https://api.x.ai/v1/chat/completions'
            }
        };

        // Fonctions de gestion des cl√©s API
        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value;
            const provider = document.querySelector('input[name="api_provider"]:checked').value;

            if (!apiKey.trim()) {
                alert('Veuillez saisir une cl√© API avant de sauvegarder.');
                return;
            }

            const apiData = {
                key: apiKey,
                provider: provider,
                timestamp: Date.now()
            };

            localStorage.setItem('saved_api_key', JSON.stringify(apiData));
            updateApiSecurityInfo(true);

            // Animation de confirmation
            const saveBtn = document.getElementById('saveApiKeyBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '‚úì Sauvegard√©';
            saveBtn.style.background = '#27ae60';

            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.style.background = '#27ae60';
            }, 2000);
        }

        function loadSavedApiKey() {
            const saved = localStorage.getItem('saved_api_key');
            if (saved) {
                try {
                    const apiData = JSON.parse(saved);
                    document.getElementById('apiKey').value = apiData.key;

                    // Restaurer le provider s√©lectionn√©
                    const providerRadio = document.querySelector(`input[name="api_provider"][value="${apiData.provider}"]`);
                    if (providerRadio) {
                        providerRadio.checked = true;
                        updateApiConfig();
                    }

                    updateApiSecurityInfo(true);
                } catch (e) {
                    console.error('Erreur lors de la restauration de la cl√© API:', e);
                    localStorage.removeItem('saved_api_key');
                }
            } else {
                updateApiSecurityInfo(false);
            }
        }

        function clearSavedApiKey() {
            if (confirm('Voulez-vous effacer la cl√© API sauvegard√©e ?\n\nVous devrez la ressaisir lors de votre prochaine visite.')) {
                localStorage.removeItem('saved_api_key');
                document.getElementById('apiKey').value = '';
                updateApiSecurityInfo(false);
                alert('Cl√© API effac√©e.');
            }
        }

        function updateApiSecurityInfo(isSaved) {
            const infoElement = document.getElementById('apiSecurityInfo');
            if (isSaved) {
                infoElement.innerHTML = 'üîí Cl√© API sauvegard√©e localement dans votre navigateur - <button onclick="clearSavedApiKey()" style="background: #e74c3c; color: white; border: none; padding: 2px 8px; border-radius: 3px; font-size: 0.8em; cursor: pointer;">Effacer</button>';
            } else {
                infoElement.innerHTML = 'üîì Cl√© API non sauvegard√©e - Cliquez sur "Sauver" pour la m√©moriser';
            }
        }

        // Gestion changement d'API
        document.addEventListener('DOMContentLoaded', function() {
            const apiRadios = document.querySelectorAll('input[name="api_provider"]');
            const apiKeyInput = document.getElementById('apiKey');
            const apiHelp = document.getElementById('apiHelp');

            function updateApiConfig() {
                const selected = document.querySelector('input[name="api_provider"]:checked').value;
                const config = apiConfigs[selected];

                apiKeyInput.placeholder = config.placeholder;
                apiHelp.innerHTML = config.help;
            }

            // Charger la cl√© API sauvegard√©e au chargement de la page
            loadSavedApiKey();

            apiRadios.forEach(radio => {
                radio.addEventListener('change', updateApiConfig);
            });

            // Sauvegarder automatiquement quand on tape dans le champ (avec d√©lai)
            let saveTimeout;
            apiKeyInput.addEventListener('input', function() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    if (apiKeyInput.value.trim().length > 10) { // Seulement si √ßa ressemble √† une vraie cl√©
                        const currentSaved = localStorage.getItem('saved_api_key');
                        if (currentSaved) {
                            // Mise √† jour automatique si d√©j√† une cl√© sauvegard√©e
                            saveApiKey();
                        }
                    }
                }, 1500); // Attendre 1.5 secondes apr√®s la derni√®re frappe
            });

            // Gestion secteur personnalis√©
            const sectorRadios = document.querySelectorAll('input[name="sector"]');
            const customSectorInput = document.getElementById('sector_custom');

            sectorRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'autre') {
                        customSectorInput.style.display = 'block';
                        customSectorInput.required = true;
                    } else {
                        customSectorInput.style.display = 'none';
                        customSectorInput.required = false;
                        customSectorInput.value = '';
                    }
                });
            });

            // Date par d√©faut
            document.getElementById('audit_date').value = new Date().toISOString().split('T')[0];

            // Event listener pour le bouton de g√©n√©ration
            document.getElementById('generateReport').addEventListener('click', generateReport);
        });

        // Collecte des donn√©es du formulaire
        function collectFormData() {
            const selectedSector = document.querySelector('input[name="sector"]:checked');
            const sector = selectedSector ? 
                (selectedSector.value === 'autre' ? document.getElementById('sector_custom').value : selectedSector.value) 
                : '';

            const data = {
                api_provider: document.querySelector('input[name="api_provider"]:checked').value,
                company_info: {
                    name: document.getElementById('company_name').value,
                    contact: document.getElementById('contact_name').value,
                    role: document.getElementById('contact_role').value,
                    date: document.getElementById('audit_date').value,
                    employees: document.getElementById('employee_count').value,
                    sector: sector,
                    context: document.getElementById('company_context').value
                },
                scores: {},
                notes: {},
                pain_points: document.getElementById('pain_points').value,
                ambitions: document.getElementById('ambitions').value,
                budget_range: document.getElementById('budget_range').value,
                urgency: document.getElementById('urgency').value
            };

            // Collecte des cases coch√©es par cat√©gorie
            const categories = [
                'commercial', 'vente', 'production', 'ressources', 'service_client',
                'rh', 'finance', 'infrastructure', 'securite', 'data', 'innovation'
            ];

            categories.forEach(category => {
                const checkboxes = document.querySelectorAll(`input[name="${category}"]:checked`);
                data.scores[category] = Array.from(checkboxes).map(cb => cb.value);
            });

            // Collecte des questions √† niveaux (radio buttons)
            const radioQuestions = [
                'site_web_pro', 'crm_structure', 'analytics', 'marketing_automation',
                'logiciel_devis', 'suivi_pipeline', 'planning_digital', 'gestion_stocks',
                'helpdesk', 'portail_client', 'cloud_adoption', 'parc_moderne',
                'erp_integre', 'sauvegarde_auto'
            ];
            radioQuestions.forEach(question => {
                const radioSelected = document.querySelector(`input[name="${question}"]:checked`);
                if (radioSelected) {
                    data.scores[question] = [parseFloat(radioSelected.value)];
                }
            });

            // Collecte des notes textuelles
            const noteFields = [
                'commercial_notes', 'vente_notes', 'production_notes', 'service_notes',
                'rh_notes', 'finance_notes', 'infrastructure_notes', 'innovation_notes'
            ];
            
            noteFields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    data.notes[field] = element.value;
                }
            });

            return data;
        }

        // Calcul des scores de maturit√©
        function calculateMaturityScores(data) {
            const domainMapping = {
                'Commercial & Marketing': ['commercial', 'vente'],
                'Production & Op√©rations': ['production', 'ressources'],
                'Service Client': ['service_client'],
                'Ressources Humaines': ['rh'],
                'Finance & Administration': ['finance'],
                'Infrastructure': ['infrastructure', 'securite'],
                'Innovation & Data': ['data', 'innovation']
            };

            // Mapping des questions radio vers leurs domaines
            const radioQuestionsMapping = {
                'site_web_pro': 'Commercial & Marketing',
                'crm_structure': 'Commercial & Marketing',
                'analytics': 'Commercial & Marketing',
                'marketing_automation': 'Commercial & Marketing',
                'logiciel_devis': 'Commercial & Marketing',
                'suivi_pipeline': 'Commercial & Marketing',
                'planning_digital': 'Production & Op√©rations',
                'gestion_stocks': 'Production & Op√©rations',
                'helpdesk': 'Service Client',
                'portail_client': 'Service Client',
                'cloud_adoption': 'Infrastructure',
                'parc_moderne': 'Infrastructure',
                'erp_integre': 'Finance & Administration',
                'sauvegarde_auto': 'Infrastructure'
            };

            const maxScoresByCategory = {
                commercial: 2, vente: 3, production: 4, ressources: 4, // Ajust√©s avec les questions radio
                service_client: 4, rh: 6, finance: 5,
                infrastructure: 3, securite: 4, data: 5, innovation: 5
            };

            const scores = {};
            let globalScore = 0;
            let totalPossible = 0;

            Object.keys(domainMapping).forEach(domain => {
                let domainScore = 0;
                let domainMax = 0;

                domainMapping[domain].forEach(category => {
                    // Score des checkboxes traditionnelles
                    const categoryScore = data.scores[category] ? data.scores[category].length : 0;
                    const categoryMax = maxScoresByCategory[category];

                    domainScore += categoryScore;
                    domainMax += categoryMax;
                });

                // Ajout des scores des questions radio pour ce domaine
                Object.keys(radioQuestionsMapping).forEach(radioQuestion => {
                    if (radioQuestionsMapping[radioQuestion] === domain) {
                        const radioScore = data.scores[radioQuestion] ? data.scores[radioQuestion][0] : 0;
                        domainScore += radioScore;
                        domainMax += 1; // chaque question radio vaut max 1 point
                    }
                });

                scores[domain] = Math.round((domainScore / domainMax) * 100);
                globalScore += domainScore;
                totalPossible += domainMax;
            });

            scores['Global'] = Math.round((globalScore / totalPossible) * 100);
            return scores;
        }

        // Appel API multi-provider
        async function generateAIAnalysis(data, scores) {
            const apiKey = document.getElementById('apiKey').value;
            const provider = data.api_provider;
            
            if (!apiKey) {
                throw new Error('Cl√© API requise');
            }

            const sectorContext = getSectorContext(data.company_info.sector);
            const prompt = createPrompt(data, scores, sectorContext);

            try {
                switch (provider) {
                    case 'anthropic':
                        return await callAnthropicAPI(apiKey, prompt);
                    case 'openai':
                        return await callOpenAIAPI(apiKey, prompt);
                    case 'gemini':
                        return await callGeminiAPI(apiKey, prompt);
                    case 'grok':
                        return await callGrokAPI(apiKey, prompt);
                    default:
                        throw new Error('Provider non support√©');
                }
            } catch (error) {
                console.error('Erreur API d√©taill√©e:', error);

                // Gestion sp√©cifique des erreurs
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    // V√©rifier si le proxy PHP existe
                    try {
                        const proxyTest = await fetch('./api-proxy.php', { method: 'POST' });
                        if (proxyTest.status === 400) {
                            throw new Error(
                                `üîß PROXY PHP D√âTECT√â MAIS ERREUR DE DONN√âES\n\n` +
                                `Le proxy PHP est disponible mais n'a pas re√ßu les bonnes donn√©es.\n` +
                                `Ceci est probablement un bug temporaire.\n\n` +
                                `üí° R√©essayez dans quelques secondes ou utilisez le mode basique.`
                            );
                        }
                    } catch (proxyError) {
                        throw new Error(
                            `üö´ PROXY PHP NON DISPONIBLE\n\n` +
                            `Le fichier api-proxy.php n'est pas accessible sur ce serveur.\n\n` +
                            `‚úÖ SOLUTIONS:\n` +
                            `1. V√©rifiez que api-proxy.php est dans le m√™me dossier\n` +
                            `2. V√©rifiez que PHP est activ√© sur votre serveur\n` +
                            `3. Utilisez le mode basique (qui fonctionne sans API)\n\n` +
                            `üí° Le mode basique g√©n√®re d'excellents rapports !`
                        );
                    }
                }

                // Autres types d'erreurs
                if (error.message.includes('401') || error.message.includes('403')) {
                    throw new Error('‚ùå Cl√© API invalide ou expir√©e. V√©rifiez votre cl√©.');
                }

                if (error.message.includes('429')) {
                    throw new Error('‚è±Ô∏è Limite de taux d√©pass√©e. Attendez quelques minutes.');
                }

                throw error;
            }
        }

        function createPrompt(data, scores, sectorContext) {
            return `Tu es un consultant en transformation digitale expert tous secteurs. 

Voici les r√©sultats d'un audit de maturit√© digitale pour l'entreprise ${data.company_info.name} :

INFORMATIONS ENTREPRISE :
- Secteur : ${data.company_info.sector}
- Taille : ${data.company_info.employees} employ√©s
- Contact : ${data.company_info.contact} (${data.company_info.role})
- Contexte : ${data.company_info.context}

CONTEXTE SECTORIEL :
${sectorContext}

SCORES DE MATURIT√â :
${Object.entries(scores).map(([domain, score]) => `- ${domain}: ${score}%`).join('\n')}

POINTS DE DOULEUR :
${data.pain_points}

AMBITIONS ET CONTRAINTES :
${data.ambitions}

BUDGET : ${data.budget_range}
URGENCE : ${data.urgency}

G√©n√®re un rapport professionnel structur√© avec :

1. EXECUTIVE SUMMARY (3-4 phrases)
   - Niveau de maturit√© global et positionnement sectoriel
   - Enjeux cl√©s identifi√©s

2. ANALYSE D√âTAILL√âE PAR DOMAINE
   Pour chaque domaine avec score < 70% :
   - Diagnostic de l'existant
   - √âcarts par rapport aux meilleures pratiques sectorielles
   - Impacts business quantifi√©s

3. RECOMMANDATIONS PRIORIS√âES
   - Quick wins (3-6 mois, ROI rapide)
   - Projets structurants (6-18 mois, transformation)
   - Vision long terme (18+ mois, innovation)

4. ROADMAP D√âTAILL√âE
   - Phasage avec jalons cl√©s
   - Estimation budg√©taire par phase
   - Ressources n√©cessaires

5. PROCHAINES √âTAPES
   - Actions imm√©diates √† entreprendre
   - D√©cisions √† prendre
   - Planning de mise en ≈ìuvre

Adapte le vocabulaire et les recommandations au secteur sp√©cifique. Reste pragmatique et actionnable.`;
        }

        // Fonction universelle pour appeler le proxy
        async function callAPIProxy(provider, apiKey, prompt) {
            const response = await fetch('./api-proxy.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    provider: provider,
                    apiKey: apiKey,
                    prompt: prompt
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Erreur inconnue' }));
                throw new Error(`Erreur API ${provider}: ${errorData.error || response.statusText}`);
            }

            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error || 'Erreur de traitement API');
            }

            return result.text;
        }

        async function callAnthropicAPI(apiKey, prompt) {
            return await callAPIProxy('anthropic', apiKey, prompt);
        }

        async function callOpenAIAPI(apiKey, prompt) {
            return await callAPIProxy('openai', apiKey, prompt);
        }

        async function callGeminiAPI(apiKey, prompt) {
            return await callAPIProxy('gemini', apiKey, prompt);
        }

        async function callGrokAPI(apiKey, prompt) {
            return await callAPIProxy('grok', apiKey, prompt);
        }

        function getSectorContext(sector) {
            const contexts = {
                'industrie': 'Secteur industriel : Focus sur l\'automatisation, IoT, maintenance pr√©dictive, ERP int√©gr√©, gestion de production.',
                'btp': 'Secteur BTP : Enjeux mobilit√©, gestion de chantiers, planification, s√©curit√©, relation clients projets.',
                'services': 'Secteur services : Focus CRM, facturation temps, gestion projets, collaboration, expertise.',
                'commerce': 'Commerce/Distribution : E-commerce, omnicanalit√©, gestion stocks, logistique, exp√©rience client.',
                'sante': 'Secteur sant√© : Conformit√© r√©glementaire, dossiers patients, t√©l√©m√©decine, s√©curit√© donn√©es.',
                'education': '√âducation/Formation : LMS, e-learning, gestion √©tudiants, outils p√©dagogiques num√©riques.',
                'transport': 'Transport/Logistique : Tra√ßabilit√©, optimisation tourn√©es, gestion flottes, supply chain.',
                'agriculture': 'Agriculture : Precision farming, IoT, tra√ßabilit√©, gestion exploitations, circuits courts.',
                'finance': 'Finance/Banque : Conformit√©, s√©curit√© renforc√©e, digitalisation parcours client, fintech.'
            };
            return contexts[sector] || 'Secteur sp√©cifique : Analyse adapt√©e aux particularit√©s m√©tier.';
        }

        function generateBasicReport(data, scores) {
            const sector = data.company_info.sector;
            const globalScore = scores['Global'];
            const domains = Object.keys(scores).filter(domain => domain !== 'Global');

            // D√©terminer le niveau de maturit√©
            let maturityLevel, maturityDescription;
            if (globalScore >= 80) {
                maturityLevel = 'Avanc√©e';
                maturityDescription = 'L\'entreprise dispose d\'une maturit√© digitale √©lev√©e avec des processus largement automatis√©s.';
            } else if (globalScore >= 60) {
                maturityLevel = 'Interm√©diaire';
                maturityDescription = 'L\'entreprise a amorc√© sa transformation digitale mais des am√©liorations significatives sont possibles.';
            } else if (globalScore >= 40) {
                maturityLevel = 'Basique';
                maturityDescription = 'L\'entreprise utilise des outils digitaux de base mais manque de vision d\'ensemble et d\'int√©gration.';
            } else {
                maturityLevel = '√âmergente';
                maturityDescription = 'L\'entreprise d√©bute sa transformation digitale avec de nombreuses opportunit√©s d\'am√©lioration.';
            }

            // Identifier les domaines forts et faibles
            const sortedDomains = domains.sort((a, b) => scores[b] - scores[a]);
            const topDomains = sortedDomains.slice(0, 2);
            const weakDomains = sortedDomains.slice(-2);

            // G√©n√©rer les recommandations sectorielles
            const sectorRecommendations = getSectorRecommendations(sector, scores);
            const priorityRecommendations = getPriorityRecommendations(data, scores);

            return `
                <div style="line-height: 1.8; font-size: 14px;">
                    <h2 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
                        RAPPORT D'AUDIT - ${data.company_info.name.toUpperCase()}
                    </h2>

                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <h3 style="color: #3498db; margin-bottom: 15px;">üìä SYNTH√àSE EX√âCUTIVE</h3>
                        <p><strong>Niveau de maturit√© :</strong> ${maturityLevel} (${globalScore}%)</p>
                        <p><strong>Secteur d'activit√© :</strong> ${getSectorLabel(sector)}</p>
                        <p><strong>Taille :</strong> ${data.company_info.employees} employ√©s</p>
                        <br>
                        <p>${maturityDescription}</p>
                        ${data.pain_points ? `<p><strong>Points de douleur identifi√©s :</strong> ${data.pain_points}</p>` : ''}
                    </div>

                    <h3 style="color: #3498db; margin: 25px 0 15px 0;">üéØ ANALYSE PAR DOMAINE</h3>

                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="color: #27ae60; margin-bottom: 10px;">‚úÖ POINTS FORTS</h4>
                        ${topDomains.map(domain => `
                            <p><strong>${domain} (${scores[domain]}%)</strong> - ${getDomainAnalysis(domain, scores[domain], 'strong')}</p>
                        `).join('')}
                    </div>

                    <div style="background: #fef9e7; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="color: #f39c12; margin-bottom: 10px;">‚ö†Ô∏è AXES D'AM√âLIORATION</h4>
                        ${weakDomains.map(domain => `
                            <p><strong>${domain} (${scores[domain]}%)</strong> - ${getDomainAnalysis(domain, scores[domain], 'weak')}</p>
                        `).join('')}
                    </div>

                    <h3 style="color: #3498db; margin: 25px 0 15px 0;">üöÄ RECOMMANDATIONS PRIORITAIRES</h3>

                    <div style="background: #fff; border-left: 4px solid #3498db; padding: 20px; margin: 15px 0;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">QUICK WINS (3-6 mois)</h4>
                        ${priorityRecommendations.quickWins.map(rec => `<p>‚Ä¢ ${rec}</p>`).join('')}
                    </div>

                    <div style="background: #fff; border-left: 4px solid #e74c3c; padding: 20px; margin: 15px 0;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">PROJETS STRUCTURANTS (6-18 mois)</h4>
                        ${priorityRecommendations.structural.map(rec => `<p>‚Ä¢ ${rec}</p>`).join('')}
                    </div>

                    <h4 style="color: #3498db; margin: 25px 0 15px 0;">üìã RECOMMANDATIONS SECTORIELLES</h4>
                    <div style="background: #f0f8ff; padding: 15px; border-radius: 8px;">
                        ${sectorRecommendations.map(rec => `<p>‚Ä¢ ${rec}</p>`).join('')}
                    </div>

                    <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin: 25px 0;">
                        <h4 style="color: #856404; margin-bottom: 10px;">‚ö° PROCHAINES √âTAPES</h4>
                        <p>1. <strong>Prioriser</strong> les quick wins selon votre budget (${data.budget_range || '√† d√©finir'})</p>
                        <p>2. <strong>Constituer</strong> une √©quipe projet avec un sponsor m√©tier</p>
                        <p>3. <strong>Planifier</strong> selon votre niveau d'urgence (${data.urgency || '√† d√©finir'})</p>
                        <p>4. <strong>Mesurer</strong> les gains apr√®s chaque √©tape</p>

                        <p style="margin-top: 15px; font-style: italic; color: #666;">
                            üí° <strong>Conseil :</strong> Pour une analyse plus approfondie et personnalis√©e,
                            utilisez une cl√© API pour b√©n√©ficier de recommandations adapt√©es par intelligence artificielle.
                        </p>
                    </div>
                </div>
            `;
        }

        function getSectorLabel(sector) {
            const labels = {
                'industrie': 'Industrie & Manufacturing',
                'btp': 'BTP & Construction',
                'services': 'Services & Conseil',
                'commerce': 'Commerce & Distribution',
                'sante': 'Sant√© & M√©dical',
                'education': '√âducation & Formation',
                'transport': 'Transport & Logistique',
                'agriculture': 'Agriculture & Agroalimentaire',
                'finance': 'Finance & Banque'
            };
            return labels[sector] || sector;
        }

        function getDomainAnalysis(domain, score, type) {
            const analyses = {
                'Commercial & Marketing': {
                    strong: 'Bonne ma√Ætrise des outils de prospection et de suivi client. L\'entreprise capitalise efficacement sur ses relations commerciales.',
                    weak: 'Opportunit√©s d\'am√©lioration sur la digitalisation du processus commercial et l\'automatisation du marketing.'
                },
                'Production & Op√©rations': {
                    strong: 'Processus op√©rationnels bien structur√©s avec des outils de planification et de suivi adapt√©s.',
                    weak: 'Potentiel d\'optimisation via l\'automatisation, l\'IoT et l\'am√©lioration du suivi temps r√©el.'
                },
                'Service Client': {
                    strong: 'Organisation client satisfaisante avec des processus de support structur√©s.',
                    weak: 'Am√©lioration possible de l\'exp√©rience client via des outils de self-service et d\'automatisation.'
                },
                'Ressources Humaines': {
                    strong: 'Gestion RH organis√©e avec de bons outils de collaboration et de suivi des √©quipes.',
                    weak: 'Opportunit√©s de digitalisation des processus RH et d\'am√©lioration de la collaboration.'
                },
                'Finance & Administration': {
                    strong: 'Processus administratifs et financiers bien ma√Ætris√©s avec des outils adapt√©s.',
                    weak: 'Potentiel d\'automatisation et d\'int√©gration des processus administratifs et financiers.'
                },
                'Infrastructure': {
                    strong: 'Infrastructure technique robuste permettant de supporter la croissance digitale.',
                    weak: 'Modernisation n√©cessaire de l\'infrastructure pour supporter une transformation digitale avanc√©e.'
                },
                'Innovation & Data': {
                    strong: 'Bonne approche de l\'innovation et exploitation efficace des donn√©es disponibles.',
                    weak: 'Opportunit√©s importantes d\'exploitation des donn√©es et de d√©veloppement d\'une culture d\'innovation.'
                }
            };

            return analyses[domain] ? analyses[domain][type] :
                   `Score de ${score}% dans ce domaine ${type === 'strong' ? 't√©moigne d\'une bonne ma√Ætrise' : 'indique des axes d\'am√©lioration'}.`;
        }

        function getSectorRecommendations(sector, scores) {
            const recommendations = {
                'industrie': [
                    'Int√©gration IoT pour le monitoring des √©quipements',
                    'Mise en place de maintenance pr√©dictive',
                    'Digitalisation de la cha√Æne logistique',
                    'Impl√©mentation d\'un MES (Manufacturing Execution System)'
                ],
                'btp': [
                    'Applications mobiles pour le suivi de chantiers',
                    'Maquettes num√©riques BIM pour am√©liorer la collaboration',
                    'G√©olocalisation des √©quipes et mat√©riels',
                    'D√©mat√©rialisation des rapports de chantier'
                ],
                'services': [
                    'CRM avanc√© pour la gestion de la relation client',
                    'Outils de facturation au temps et gestion de projets',
                    'Portail client pour le suivi des prestations',
                    'Knowledge management pour capitaliser l\'expertise'
                ],
                'commerce': [
                    'Plateforme e-commerce omnicanale',
                    'Gestion intelligente des stocks',
                    'Analyse pr√©dictive des ventes',
                    'Personnalisation de l\'exp√©rience client'
                ],
                'sante': [
                    'Dossier patient √©lectronique s√©curis√©',
                    'T√©l√©m√©decine et consultations √† distance',
                    'Planning intelligent des ressources',
                    'Conformit√© RGPD renforc√©e'
                ],
                'education': [
                    'Plateforme LMS pour l\'apprentissage en ligne',
                    'Outils de collaboration √©tudiants-enseignants',
                    'Gestion digitale des inscriptions et √©valuations',
                    'Analytics d\'apprentissage'
                ],
                'transport': [
                    'Optimisation des tourn√©es par algorithmes',
                    'Tra√ßabilit√© temps r√©el des exp√©ditions',
                    'Gestion intelligente de la flotte',
                    'Int√©gration EDI avec les partenaires'
                ],
                'agriculture': [
                    'Agriculture de pr√©cision avec capteurs IoT',
                    'Tra√ßabilit√© de la production',
                    'Gestion optimis√©e des ressources (eau, fertilisants)',
                    'Plateformes de vente directe'
                ],
                'finance': [
                    'Digitalisation compl√®te du parcours client',
                    'IA pour la d√©tection de fraude',
                    'API banking pour les partenariats fintech',
                    'Conformit√© r√©glementaire automatis√©e'
                ]
            };

            return recommendations[sector] || [
                'Audit approfondi des processus m√©tier',
                'Cartographie des flux d\'information',
                'Benchmark sectoriel des meilleures pratiques',
                'Roadmap de transformation adapt√©e'
            ];
        }

        function getPriorityRecommendations(data, scores) {
            const quickWins = [];
            const structural = [];

            // Analyse des scores pour g√©n√©rer des recommandations
            Object.keys(scores).forEach(domain => {
                if (domain === 'Global') return;

                const score = scores[domain];

                if (score < 30) {
                    // Domaines tr√®s faibles = projets structurants
                    if (domain.includes('Commercial')) {
                        structural.push('Impl√©mentation d\'un CRM et digitalisation du processus de vente');
                    } else if (domain.includes('Production')) {
                        structural.push('Mise en place d\'un syst√®me de planification et suivi de production');
                    } else if (domain.includes('Infrastructure')) {
                        structural.push('Modernisation compl√®te de l\'infrastructure informatique');
                    }
                } else if (score < 60) {
                    // Domaines moyens = quick wins possibles
                    if (domain.includes('Commercial')) {
                        quickWins.push('Am√©lioration du site web et mise en place d\'outils de prospection digitale');
                    } else if (domain.includes('Service Client')) {
                        quickWins.push('Cr√©ation d\'une FAQ en ligne et am√©lioration de la communication client');
                    } else if (domain.includes('RH')) {
                        quickWins.push('D√©ploiement d\'outils de collaboration (Teams, Slack) et digitalisation des plannings');
                    }
                }
            });

            // Recommandations par d√©faut si peu de donn√©es
            if (quickWins.length === 0) {
                quickWins.push(
                    'Audit de s√©curit√© informatique et mise en place de sauvegardes automatiques',
                    'Formation des √©quipes aux outils digitaux existants',
                    'D√©mat√©rialisation des documents administratifs'
                );
            }

            if (structural.length === 0) {
                structural.push(
                    '√âlaboration d\'une strat√©gie de transformation digitale globale',
                    'Choix et impl√©mentation d\'un ERP adapt√© au secteur',
                    'Mise en place d\'indicateurs de performance digitaux'
                );
            }

            return { quickWins, structural };
        }

        function upgradeToAI() {
            const apiSection = document.querySelector('.api-config');
            apiSection.scrollIntoView({ behavior: 'smooth' });
            document.getElementById('apiKey').focus();
            alert('Veuillez saisir votre cl√© API ci-dessus pour b√©n√©ficier de l\'analyse IA personnalis√©e.');
        }

        // Fonction de cache pour les rapports basiques
        function getCachedBasicReport(formData) {
            const cacheKey = 'basic_report_' + JSON.stringify(formData).length; // Simple hash
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                const parsed = JSON.parse(cached);
                // V√©rifier si les donn√©es sont identiques (simple v√©rification)
                if (parsed.timestamp > Date.now() - 3600000) { // Cache valide 1 heure
                    return parsed.report;
                }
            }
            return null;
        }

        function cacheBasicReport(formData, report) {
            const cacheKey = 'basic_report_' + JSON.stringify(formData).length;
            const cacheData = {
                report: report,
                timestamp: Date.now(),
                company: formData.company_info.name
            };
            localStorage.setItem(cacheKey, JSON.stringify(cacheData));
        }

        // Analytics pour suivre l'utilisation des modes
        function trackUsage(mode) {
            const usage = JSON.parse(localStorage.getItem('audit_usage') || '{"ai": 0, "basic": 0}');
            usage[mode]++;
            localStorage.setItem('audit_usage', JSON.stringify(usage));
        }

        // Fonction pour afficher les statistiques d'utilisation
        function showUsageStats() {
            const usage = JSON.parse(localStorage.getItem('audit_usage') || '{"ai": 0, "basic": 0}');
            const total = usage.ai + usage.basic;
            if (total > 0) {
                alert(`Statistiques d'utilisation :\n` +
                      `Rapports IA : ${usage.ai} (${Math.round(usage.ai/total*100)}%)\n` +
                      `Rapports basiques : ${usage.basic} (${Math.round(usage.basic/total*100)}%)\n` +
                      `Total : ${total} rapports g√©n√©r√©s`);
            } else {
                alert('Aucun rapport g√©n√©r√© pour le moment.');
            }
        }

        // Fonction pour cr√©er des abr√©viations intelligentes
        function createSmartLabel(domain) {
            const labelMappings = {
                'Commercial & Marketing': 'Commercial & Mkt',
                'Production & Op√©rations': 'Production & Ops',
                'Service Client': 'Service Client',
                'Ressources Humaines': 'RH & Collaboration',
                'Finance & Administration': 'Finance & Admin',
                'Infrastructure': 'Infrastructure',
                'Innovation & Data': 'Innovation & Data'
            };

            // Utiliser le mapping s'il existe, sinon utiliser une troncature intelligente
            if (labelMappings[domain]) {
                return labelMappings[domain];
            }

            // Troncature intelligente : √©viter de couper au milieu d'un mot
            if (domain.length <= 18) {
                return domain;
            }

            // Chercher le dernier espace avant la limite de 18 caract√®res
            const truncated = domain.substring(0, 18);
            const lastSpace = truncated.lastIndexOf(' ');

            if (lastSpace > 10) { // S'assurer qu'on n'est pas trop court
                return domain.substring(0, lastSpace) + '...';
            }

            return truncated + '...';
        }

        // Fonctions graphiques et utilitaires
        function createRadarChart(scores) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            if (radarChart) radarChart.destroy();

            const domains = Object.keys(scores).filter(domain => domain !== 'Global');
            
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: domains.map(domain => createSmartLabel(domain)),
                    datasets: [{
                        label: 'Score de Maturit√© (%)',
                        data: domains.map(domain => scores[domain]),
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        pointBackgroundColor: 'rgba(52, 152, 219, 1)',
                        pointBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // Cacher la l√©gende pour √©viter la redondance
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    // Afficher le nom complet dans le tooltip
                                    const index = context[0].dataIndex;
                                    return domains[index];
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: {
                                stepSize: 20,
                                font: {
                                    size: 11
                                }
                            },
                            pointLabels: {
                                font: {
                                    size: 11,
                                    weight: 'bold'
                                },
                                color: '#2c3e50'
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 20,
                            left: 20,
                            right: 20
                        }
                    }
                }
            });
        }

        function createBarChart(scores) {
            const ctx = document.getElementById('barChart').getContext('2d');
            if (barChart) barChart.destroy();

            const domains = Object.keys(scores).filter(domain => domain !== 'Global');
            
            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: domains.map(domain => createSmartLabel(domain)),
                    datasets: [{
                        label: 'Score de Maturit√© (%)',
                        data: domains.map(domain => scores[domain]),
                        backgroundColor: domains.map(domain => {
                            const score = scores[domain];
                            if (score >= 80) return 'rgba(46, 204, 113, 0.8)';
                            if (score >= 60) return 'rgba(241, 196, 15, 0.8)';
                            if (score >= 40) return 'rgba(230, 126, 34, 0.8)';
                            return 'rgba(231, 76, 60, 0.8)';
                        })
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // Cacher la l√©gende pour √©viter la redondance
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    // Afficher le nom complet dans le tooltip
                                    const index = context[0].dataIndex;
                                    return domains[index];
                                },
                                label: function(context) {
                                    return 'Score: ' + context.parsed.y + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                font: {
                                    size: 11
                                }
                            },
                            title: {
                                display: true,
                                text: 'Score de Maturit√© (%)',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 10,
                                    weight: 'bold'
                                },
                                color: '#2c3e50',
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10,
                            left: 10,
                            right: 10
                        }
                    }
                }
            });
        }

        function displayGlobalScores(scores) {
            const container = document.getElementById('globalScores');
            const globalScore = scores['Global'];
            
            let maturityLevel = '';
            let maturityColor = '';
            
            if (globalScore >= 80) { maturityLevel = 'Avanc√©e'; maturityColor = '#2ecc71'; }
            else if (globalScore >= 60) { maturityLevel = 'Interm√©diaire'; maturityColor = '#f1c40f'; }
            else if (globalScore >= 40) { maturityLevel = 'Basique'; maturityColor = '#e67e22'; }
            else { maturityLevel = '√âmergente'; maturityColor = '#e74c3c'; }

            const domains = Object.keys(scores).filter(domain => domain !== 'Global');
            const sortedDomains = domains.sort((a, b) => scores[b] - scores[a]);

            container.innerHTML = `
                <div class="score-item">
                    <div class="score-value">${globalScore}%</div>
                    <div class="score-label">Score Global</div>
                </div>
                <div class="score-item" style="background: ${maturityColor};">
                    <div class="score-value">${maturityLevel}</div>
                    <div class="score-label">Maturit√©</div>
                </div>
                <div class="score-item">
                    <div class="score-value">${scores[sortedDomains[0]]}%</div>
                    <div class="score-label">Point fort</div>
                </div>
                <div class="score-item">
                    <div class="score-value">${scores[sortedDomains[sortedDomains.length - 1]]}%</div>
                    <div class="score-label">√Ä am√©liorer</div>
                </div>
            `;
        }

        async function generateReport() {
            const generateBtn = document.getElementById('generateReport');
            const loadingDiv = document.getElementById('loading');
            const reportSection = document.getElementById('reportSection');

            try {
                const apiKey = document.getElementById('apiKey').value;
                const companyName = document.getElementById('company_name').value;

                if (!companyName) {
                    alert('Veuillez saisir le nom de l\'entreprise');
                    return;
                }

                generateBtn.disabled = true;
                loadingDiv.style.display = 'block';
                reportSection.style.display = 'none';

                const formData = collectFormData();
                const scores = calculateMaturityScores(formData);

                let reportContentHTML;
                let isDegradedMode = false;

                // Update loading message
                const loadingText = loadingDiv.querySelector('p');
                loadingText.textContent = apiKey ?
                    'Analyse en cours et g√©n√©ration du rapport personnalis√©...' :
                    'G√©n√©ration du rapport d\'analyse basique...';

                if (!apiKey) {
                    // Mode d√©grad√© sans API
                    const confirmDegraded = confirm(
                        'ü§ñ MODE BASIQUE DISPONIBLE\n\n' +
                        'Aucune cl√© API d√©tect√©e, mais vous pouvez quand m√™me g√©n√©rer un excellent rapport !\n\n' +
                        '‚úÖ INCLUS DANS LE MODE BASIQUE :\n' +
                        '‚Ä¢ Calcul pr√©cis des scores de maturit√©\n' +
                        '‚Ä¢ Graphiques interactifs (radar + barres)\n' +
                        '‚Ä¢ Analyse d√©taill√©e par domaine\n' +
                        '‚Ä¢ Recommandations sectorielles sp√©cialis√©es\n' +
                        '‚Ä¢ Quick wins et projets structurants\n' +
                        '‚Ä¢ Plan d\'action prioris√©\n\n' +
                        '‚ö° RAPPORT G√âN√âR√â INSTANTAN√âMENT !\n\n' +
                        'Continuer avec le mode basique ?'
                    );

                    if (!confirmDegraded) {
                        generateBtn.disabled = false;
                        loadingDiv.style.display = 'none';
                        // Proposer d'aller √† la section API
                        if (confirm('Voulez-vous configurer une cl√© API pour l\'analyse IA personnalis√©e ?')) {
                            document.querySelector('.api-config').scrollIntoView({ behavior: 'smooth' });
                            document.getElementById('apiKey').focus();
                        }
                        return;
                    }

                    // G√©n√©rer rapport d√©grad√© (avec cache)
                    let cachedReport = getCachedBasicReport(formData);
                    if (cachedReport) {
                        reportContentHTML = cachedReport;
                    } else {
                        reportContentHTML = generateBasicReport(formData, scores);
                        cacheBasicReport(formData, reportContentHTML);
                    }
                    isDegradedMode = true;
                    trackUsage('basic');
                } else {
                    // Mode IA normal
                    const aiAnalysis = await generateAIAnalysis(formData, scores);
                    reportContentHTML = `
                        <div style="white-space: pre-wrap; line-height: 1.8; font-size: 14px;">
                            ${aiAnalysis
                                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #2c3e50; font-size: 1.1em;">$1</strong>')
                                .replace(/^(\d+\..*$)/gm, '<h3 style="color: #3498db; margin: 20px 0 10px 0; font-size: 1.2em;">$1</h3>')
                                .replace(/^(-.*$)/gm, '<li style="margin: 5px 0;">$1</li>')
                                .replace(/\n/g, '<br>')
                            }
                        </div>
                    `;
                    trackUsage('ai');
                }

                displayGlobalScores(scores);
                createRadarChart(scores);
                createBarChart(scores);

                const reportContent = document.getElementById('reportContent');

                // Ajouter l'indicateur de mode d√©grad√© si n√©cessaire
                const degradedModeIndicator = isDegradedMode ? `
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #155724; margin-bottom: 10px;">‚ö° Rapport Basique G√©n√©r√©</h4>
                        <p style="color: #155724; margin: 0;">
                            Ce rapport complet inclut tous les scores, graphiques et recommandations sectorielles.
                            Les fonctionnalit√©s IA n√©cessitent une cl√© API mais le mode basique est d√©j√† tr√®s performant !
                        </p>
                        <div style="margin-top: 10px;">
                            <button onclick="upgradeToAI()" style="background: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                                ü§ñ Activer l'IA personnalis√©e
                            </button>
                            <small style="color: #6c757d;">Optionnel - Le rapport actuel est d√©j√† complet</small>
                        </div>
                    </div>
                ` : '';

                reportContent.innerHTML = degradedModeIndicator + reportContentHTML;

                reportSection.style.display = 'block';
                reportSection.scrollIntoView({ behavior: 'smooth' });
                saveProgress();

            } catch (error) {
                console.error('Erreur:', error);
                alert(`Erreur lors de la g√©n√©ration du rapport: ${error.message}`);
            } finally {
                generateBtn.disabled = false;
                loadingDiv.style.display = 'none';
            }
        }

        // Fonctions utilitaires
        function saveProgress() {
            const formData = collectFormData();
            localStorage.setItem('audit_progress', JSON.stringify(formData));
            alert('Progression sauvegard√©e !');
        }

        function loadProgress() {
            const saved = localStorage.getItem('audit_progress');
            if (saved) {
                alert('Progression restaur√©e !');
                // Logique de restauration simplifi√©e
            } else {
                alert('Aucune sauvegarde trouv√©e.');
            }
        }


        function resetForm() {
            if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser le formulaire ?')) {
                const keepApiKey = confirm('Voulez-vous conserver la cl√© API sauvegard√©e ?');

                localStorage.removeItem('audit_progress');
                if (!keepApiKey) {
                    localStorage.removeItem('saved_api_key');
                }
                window.location.reload();
            }
        }

        function exportToPDF() { window.print(); }
        function shareReport() {
            if (navigator.share) {
                navigator.share({
                    title: 'Rapport Maturit√© Digitale',
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                alert('Lien copi√© !');
            }
        }
        function newAudit() {
            if (confirm('D√©marrer un nouvel audit ?')) {
                const keepApiKey = confirm('Voulez-vous conserver la cl√© API sauvegard√©e ?');

                localStorage.removeItem('audit_progress');
                if (!keepApiKey) {
                    localStorage.removeItem('saved_api_key');
                }
                window.location.reload();
            }
        }
    </script>
</body>
</html>
